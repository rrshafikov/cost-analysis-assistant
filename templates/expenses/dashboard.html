{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">

    <!-- Header + overview -->
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Dashboard</h1>
            <p class="dashboard-subtitle">
                High-level overview of your recent spending.
            </p>
        </div>
        <div>
            <a href="{% url "expense_create" %}" class="primary-button primary-button-small">
                Add expense
            </a>
        </div>
    </header>

    {% if has_overview %}
        <section class="dashboard-summary" style="margin-bottom: 16px;">
            <p class="dashboard-total-label">
                Last 30 days · all banks and currencies
            </p>
            <p class="dashboard-total-value">
                {{ overview_total|floatformat:2 }} RUB
            </p>
            <p class="dashboard-total-label">
                {{ overview_count }} expenses · avg per day:
                {{ overview_avg_per_day|floatformat:2 }} RUB
            </p>
        </section>
    {% else %}
        <section class="dashboard-empty" style="margin-bottom: 16px;">
            <h2 class="dashboard-empty-title">No expenses in the last 30 days.</h2>
            <p class="dashboard-empty-text">
                Import a statement from your bank or add the first expense manually.
            </p>
            <a href="{% url "statement_import" %}" class="primary-button" style="margin-bottom: 8px;">
                Import statement
            </a>
            <a href="{% url "expense_create" %}" class="secondary-link">
                Add manually
            </a>
        </section>
    {% endif %}

    <!-- Divider -->
    <div style="height: 1px; background: rgba(148,163,184,0.25); margin: 12px 0 18px;"></div>

    <!-- Detailed view with filters -->
    <section>
        <h2 class="dashboard-section-title" style="margin-bottom: 6px;">
            Detailed view with filters
        </h2>

        <!-- Filters toggle -->
        <details class="filters-toggle" {% if request.GET %}open{% endif %}>
            <summary>
                <span class="filters-toggle-label">Filters</span>
                <span class="filters-toggle-arrow">▾</span>
            </summary>

            <div class="filters-panel">

                <!-- BANK -->
                <select name="bank"
                        form="filters-form"
                        class="filter-pill">
                    <option value="">All banks</option>
                    {% for bank in available_banks %}
                        <option value="{{ bank }}" {% if request.GET.bank == bank %}selected{% endif %}>
                            {{ bank }}
                        </option>
                    {% endfor %}
                </select>

                <!-- CURRENCY -->
                <select name="currency"
                        form="filters-form"
                        class="filter-pill">
                    <option value="">All currencies</option>
                    {% for cur in available_currencies %}
                        <option value="{{ cur }}" {% if request.GET.currency == cur %}selected{% endif %}>
                            {{ cur }}
                        </option>
                    {% endfor %}
                </select>

                <!-- CATEGORY -->
                <select name="category"
                        form="filters-form"
                        class="filter-pill">
                    <option value="">All categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>

                <!-- DATE FROM -->
                <input type="date"
                       name="date_from"
                       value="{{ request.GET.date_from }}"
                       form="filters-form"
                       class="filter-pill filter-date">

                <!-- DATE TO -->
                <input type="date"
                       name="date_to"
                       value="{{ request.GET.date_to }}"
                       form="filters-form"
                       class="filter-pill filter-date">
            </div>

            <div style="margin-top: 10px;">
                <form id="filters-form" method="get" class="auth-form">
                    <button type="submit" class="primary-button primary-button-small">
                        Apply
                    </button>
                    <a href="{% url "dashboard" %}" class="secondary-link">Reset</a>
                    <a href="{% url "statement_import" %}" class="secondary-link">Import</a>
                    <a href="{% url "expense_list" %}" class="secondary-link">History</a>
                </form>
            </div>
        </details>

        {% if has_expenses %}

            <!-- Filtered totals -->
            <section class="dashboard-summary">
                <p class="dashboard-total-label">Filtered total</p>
                <p class="dashboard-total-value">
                    {{ total|floatformat:2 }} {{ request.GET.currency|default:"RUB" }}
                </p>
                <p class="dashboard-total-label">
                    {{ count }} expenses · avg per day:
                    {{ avg_per_day|floatformat:2 }} {{ request.GET.currency|default:"RUB" }}
                </p>
            </section>

            <!-- CHART -->
            {% if chart_values_json or chart_day_values_json %}
                <section class="dashboard-chart">
                    <div class="dashboard-chart-header">
                        <h3 class="dashboard-section-title">Spending</h3>

                        <!-- Toggle -->
                        <div class="chart-toggle">
                            <button type="button"
                                    id="chart-toggle-category"
                                    class="chart-toggle-button chart-toggle-button-active"
                                    data-mode="category">
                                By categories
                            </button>
                            <button type="button"
                                    id="chart-toggle-day"
                                    class="chart-toggle-button"
                                    data-mode="day">
                                By day
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-chart-wrapper">
                        <canvas id="expensesChart"
                                data-category-labels="{{ chart_labels_json|escape }}"
                                data-category-values="{{ chart_values_json|escape }}"
                                data-day-labels="{{ chart_day_labels_json|escape }}"
                                data-day-values="{{ chart_day_values_json|escape }}">
                        </canvas>
                    </div>
                </section>
            {% endif %}

        {% else %}
            <section class="dashboard-empty">
                <h3 class="dashboard-empty-title">No expenses for current filters.</h3>
                <p class="dashboard-empty-text">
                    Try adjusting or resetting filter values.
                </p>
            </section>
        {% endif %}
    </section>

</div>
{% endblock %}

{% block extra_js %}
    {% load static %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static "js/dashboard_chart.js" %}"></script>
{% endblock %}
