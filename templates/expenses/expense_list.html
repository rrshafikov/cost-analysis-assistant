{% extends "base.html" %}
{% block title %}Expenses{% endblock %}

{% block content %}
<div class="dashboard">

    <!-- Header -->
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Expenses</h1>
            <p class="dashboard-subtitle">All operations that match your filters.</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{% url "expense_create" %}" class="primary-button primary-button-small">
                Add expense
            </a>
        </div>
    </header>

    <!-- FILTERS DROPDOWN -->
    <details class="filters-toggle" {% if request.GET %}open{% endif %}>
        <summary>
            <span class="filters-toggle-label">Filters</span>
            <span class="filters-toggle-arrow">▾</span>
        </summary>

        <div class="filters-panel">
            <select name="bank"
                    form="filters-form"
                    class="filter-pill">
                <option value="">All banks</option>
                {% for bank in available_banks %}
                    <option value="{{ bank }}" {% if request.GET.bank == bank %}selected{% endif %}>
                        {{ bank }}
                    </option>
                {% endfor %}
            </select>

            <select name="currency"
                    form="filters-form"
                    class="filter-pill">
                <option value="">All currencies</option>
                {% for cur in available_currencies %}
                    <option value="{{ cur }}" {% if request.GET.currency == cur %}selected{% endif %}>
                        {{ cur }}
                    </option>
                {% endfor %}
            </select>

            <select name="category"
                    form="filters-form"
                    class="filter-pill">
                <option value="">All categories</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                {% endfor %}
            </select>

            <input type="date"
                   name="date_from"
                   value="{{ request.GET.date_from }}"
                   form="filters-form"
                   class="filter-pill filter-date">

            <input type="date"
                   name="date_to"
                   value="{{ request.GET.date_to }}"
                   form="filters-form"
                   class="filter-pill filter-date">
        </div>

        <div style="margin-top: 10px;">
            <form id="filters-form" method="get" class="auth-form">
                <button type="submit" class="primary-button primary-button-small">
                    Apply
                </button>
                <a href="{% url "expense_list" %}" class="secondary-link">Reset</a>
                <a href="{% url "statement_import" %}" class="secondary-link">Import</a>
            </form>
        </div>
    </details>

    <!-- EXPENSES TABLE -->
    {% if expenses %}
        <div style="overflow-x: auto; margin-top: 16px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr style="text-align: left; border-bottom: 1px solid rgba(148,163,184,0.3);">
                        <th style="padding: 8px 6px;">Date</th>
                        <th style="padding: 8px 6px;">Description</th>
                        <th style="padding: 8px 6px;">Category</th>
                        <th style="padding: 8px 6px;">Bank</th>
                        <th style="padding: 8px 6px; text-align: right;">Amount</th>
                        <th style="padding: 8px 6px;"></th>
                    </tr>
                </thead>

                <tbody>
                    {% for exp in expenses %}
                        <tr style="border-bottom: 1px solid rgba(243,244,246,1);">
                            <td style="padding: 8px 6px; white-space: nowrap;">
                                {{ exp.date }}
                            </td>

                            <td style="padding: 8px 6px;">
                                {{ exp.description }}
                            </td>

                            <td style="padding: 8px 6px;">
                                {{ exp.category.name|default:"—" }}
                            </td>

                            <td style="padding: 8px 6px;">
                                {{ exp.bank|default:"—" }}
                            </td>

                            <td style="padding: 8px 6px; text-align: right;">
                                {{ exp.amount }} {{ exp.currency }}
                            </td>

                            <td style="padding: 8px 6px; white-space: nowrap; text-align: right;">
                                <a href="{% url "expense_update" exp.pk %}" class="secondary-link">Edit</a>
                                <a href="{% url "expense_delete" exp.pk %}" class="secondary-link">Delete</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
            <div style="margin-top: 12px; font-size: 13px;">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="secondary-link">
                        Previous
                    </a>
                {% endif %}

                <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="secondary-link">
                        Next
                    </a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <section class="dashboard-empty" style="margin-top: 16px;">
            <h2 class="dashboard-empty-title">No expenses found.</h2>
            <p class="dashboard-empty-text">
                Try adjusting the filters or import a bank statement.
            </p>
        </section>
    {% endif %}
</div>
{% endblock %}
